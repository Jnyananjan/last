<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: https://dhkyzhpqoreeytuyeioj.supabase.co/storage/v1/object/public/ar-content//targets.mind;" 
             color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" id="targetEntity">
        <a-plane id="displayImage" position="0 0.2 0" height="0.5" width="0.5"></a-plane>
        <a-text id="displayText" value="" position="0 0.5 0" align="center" color="white" scale="0.5 0.5 0.5"></a-text>
        
        <!-- Lighting for better visibility -->
        <a-light type="directional" position="1 1 1" intensity="1.5"></a-light>
        <a-light type="ambient" intensity="0.5"></a-light>
      </a-entity>
    </a-scene>
    
    <script>
      // Initialize Supabase
      const SUPABASE_URL = "https://dhkyzhpqoreeytuyeioj.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRoa3l6aHBxb3JlZXl0dXllaW9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIwNjE4MjUsImV4cCI6MjA1NzYzNzgyNX0.8XJ5Jd4MX0bKRbJIjyypayz-yja5LsWmgzYIZGBxm2U";
      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      let storedImages = {}; // This will hold image data from Supabase
      
      async function fetchImagesFromSupabase() {
        let { data, error } = await supabase.from("images").select("id, image_url, description");
        
        if (error) {
          console.error("Error fetching images:", error);
          return;
        }
        
        // Store images in an object with id as key
        data.forEach(item => {
          storedImages[item.id] = { src: item.image_url, text: item.description };
        });
      }
      
      // Ensure Supabase data is loaded before scanning
      document.querySelector("a-scene").addEventListener("arReady", async () => {
        console.log("MindAR is Ready! Fetching images...");
        await fetchImagesFromSupabase();
      });

      // Update image and text when target is found
      document.querySelector("a-entity[mindar-image-target]").addEventListener("targetFound", (event) => {
        console.log("Target Found!", event.detail);
        const targetIndex = event.detail.index.toString(); // Get detected image index
        const textEntity = document.getElementById("displayText");
        const imageEntity = document.getElementById("displayImage");
        
        if (storedImages[targetIndex]) {
          textEntity.setAttribute("value", storedImages[targetIndex].text);
          imageEntity.setAttribute("src", storedImages[targetIndex].src);
        } else {
          textEntity.setAttribute("value", "Unknown Image");
          imageEntity.setAttribute("src", "");
        }
      });
      
      // Debugging: Check for unexpected 3D models
      setTimeout(() => {
        const objects = document.querySelectorAll("a-entity, a-gltf-model");
        console.log("üîç Found Objects in Scene:", objects);
      }, 3000);
    </script>
  </body>
</html>
